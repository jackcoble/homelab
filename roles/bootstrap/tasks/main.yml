---
- name: Set system hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Run system updates
  ansible.builtin.dnf:
    name: "*"
    state: latest

- name: Disable SSH password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?\s*PasswordAuthentication'
    line: 'PasswordAuthentication no'
    backup: yes
    validate: '/usr/sbin/sshd -T -f %s'

- name: Disable empty-password logins
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?\s*PermitEmptyPasswords'
    line: 'PermitEmptyPasswords no'
    backup: yes
    validate: '/usr/sbin/sshd -T -f %s'

- name: Restart sshd to apply changes
  ansible.builtin.systemd:
    name: sshd
    state: restarted
    enabled: yes

- name: Add ELRepo GPG Key
  ansible.builtin.rpm_key:
    state: present
    key: https://www.elrepo.org/RPM-GPG-KEY-elrepo.org

- name: Add ELRepo repository
  ansible.builtin.dnf:
    name: https://www.elrepo.org/elrepo-release-9.el9.elrepo.noarch.rpm
    state: present
    validate_certs: yes

- name: Install drivers for LSI SAS2008
  ansible.builtin.dnf:
    name: kmod-mpt3sas
    state: present
    update_cache: yes

- name: Add OpenZFS GPG Key
  ansible.builtin.rpm_key:
    state: present
    key: https://raw.githubusercontent.com/zfsonlinux/zfsonlinux.github.com/master/zfs-release/RPM-GPG-KEY-openzfs-key2

- name: Add OpenZFS repository
  ansible.builtin.dnf:
    name: https://zfsonlinux.org/epel/zfs-release-2-3.el9.noarch.rpm
    state: present
    validate_certs: yes

- name: Add EPEL Release repository
  ansible.builtin.dnf:
    name: epel-release
    state: present
    update_cache: yes

- name: Install OpenZFS packages
  ansible.builtin.dnf:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    - zfs